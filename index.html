<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Design Portfolio — Fixed</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Playfair+Display:ital,wght@1,600&display=swap" rel="stylesheet">
    <style>
        /* 基础样式（保留你的视觉设计） */
        body{margin:0;background:#f0f2f5;font-family:Inter, sans-serif;color:#111;overflow-x:hidden;}
        canvas{position:fixed;top:0;left:0;z-index:-1;display:block;}
        nav{position:fixed;top:0;left:0;right:0;height:72px;padding:0 40px;display:flex;align-items:center;justify-content:space-between;background:rgba(255,255,255,.9);backdrop-filter:blur(10px);border-bottom:1px solid rgba(0,0,0,.05);z-index:100;}
        .content-layer{min-height:100vh;display:flex;flex-direction:column;align-items:center;}
        .hero-section{margin-top:18vh;text-align:center;}
        .hero-section h1{font-size:5rem;margin:0;letter-spacing:-2px;}
        .word-digital{font-weight:800;}
        .word-biology{font-family:"Playfair Display",serif;font-style:italic;}
        .filter-container{position:sticky;top:72px;width:100%;display:flex;justify-content:center;background:rgba(240,242,245,.95);backdrop-filter:blur(10px);padding:10px 0;z-index:90;}
        .filter-wrapper{display:flex;gap:8px;flex-wrap:wrap;}
        .filter-btn{padding:8px 20px;border-radius:40px;cursor:pointer;border:1px solid rgba(0,0,0,.05);background:#fff;}
        .filter-btn.active{background:#111;color:#fff;}
        .galleries-wrapper{max-width:1600px;width:100%;padding:30px 40px 120px;display:flex;gap:30px;box-sizing:border-box;}
        .masonry-column{flex:1;display:flex;flex-direction:column;gap:30px;}
        .photo-card{background:rgba(255,255,255,.85);border-radius:16px;overflow:hidden;border:1px solid rgba(255,255,255,.6);box-shadow:0 4px 16px rgba(0,0,0,.04);opacity:0;transform:translateY(20px);transition:.5s;}
        .photo-card.reveal{opacity:1;transform:translateY(0);}
        .photo-card:hover{box-shadow:0 20px 40px rgba(66,133,244,.15);}
        .media-wrapper img,.media-wrapper video{width:100%;display:block;}
        .card-info{padding:12px 16px;}
        .card-tag{font-size:.7rem;color:#4285F4;font-weight:700;}
        .card-title{font-size:.9rem;margin:3px 0 0 0;font-weight:800;}
        #lightbox{position:fixed;inset:0;background:rgba(0,0,0,.95);display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:.25s;z-index:999;}
        #lightbox.active{opacity:1;pointer-events:auto;}
        #lightbox-content img,#lightbox-content video{max-width:90%;max-height:90vh;border-radius:4px;}
        @media(max-width:900px){.hero-section h1{font-size:3rem}.galleries-wrapper{padding:20px}}
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>

    <div id="lightbox" aria-hidden="true">
        <div id="lightbox-content" onclick="event.stopPropagation()"></div>
    </div>

    <nav><div class="logo">ART PORTFOLIO</div></nav>

    <div class="content-layer">
        <div class="hero-section">
            <h1><span class="word-digital">Design</span> <span class="word-biology">Portfolio.</span></h1>
            <p>Latest works collection</p>
        </div>

        <div class="filter-container">
            <div id="filters" class="filter-wrapper"></div>
        </div>

        <div id="galleries-root" class="galleries-wrapper"></div>
    </div>

<script>
/* ================= 配置 ================= */
const CATEGORIES = [
    { id: "CG Style", name:"CG风格" },
    { id: "Cartoon", name:"欧美卡通" },
    { id: "Icon Design", name:"Icon设计" },
    { id: "Character", name:"角色原画" },
    { id: "Other", name:"其他类型" }
];
const EXTENSIONS = ['.webp','.jpg','.png','.jpeg','.gif','.mp4','.mov'];
const MAX_SEARCH = 300;
const MAX_ERRORS = 10; // 连续未找到多少个文件后停止本分类搜索

/* ================= DOM 句柄 ================= */
const filters = document.getElementById('filters');
const galleriesRoot = document.getElementById('galleries-root');
const lightbox = document.getElementById('lightbox');
const lightboxContent = document.getElementById('lightbox-content');

/* ================= 状态 ================= */
let loadedItems = [];
let currentFilter = 'all';
let columnsDOM = [];
let revealObserver = null;
let lazyMediaObserver = null;

/* ---------------- 初始化 ---------------- */
window.addEventListener('load', () => {
    buildFilters();
    initObservers();
    buildColumns();
    // 启动智能扫描（并行各分类）
    CATEGORIES.forEach(c => smartScan(c, 1, 0));
    initCanvas();
});

/* ================= 建立筛选按钮 ================= */
function buildFilters() {
    addFilterBtn('all','全部作品', true);
    CATEGORIES.forEach(cat => addFilterBtn(cat.id, cat.name));
}
function addFilterBtn(id, label, active=false) {
    const btn = document.createElement('div');
    btn.className = 'filter-btn' + (active ? ' active' : '');
    btn.textContent = label;
    btn.onclick = () => {
        document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        currentFilter = id;
        layout(); // 重新布局
        // 可选：把筛选栏滚回视野
        const top = document.querySelector('.filter-container').offsetTop;
        if(window.scrollY > top) window.scrollTo({top: top - 80, behavior:'smooth'});
    };
    filters.appendChild(btn);
}

/* ================= IntersectionObservers ================= */
function initObservers(){
    // revealObserver：元素进入视口触发 reveal 动画
    revealObserver = new IntersectionObserver((entries, obs) => {
        entries.forEach(e => {
            if(e.isIntersecting) {
                e.target.classList.add('reveal');
                obs.unobserve(e.target);
            }
        });
    }, { threshold: 0.06 });

    // lazyMediaObserver：当卡片快要进入视口时，把 data-src -> src
    lazyMediaObserver = new IntersectionObserver((entries, obs) => {
        entries.forEach(e => {
            if(e.isIntersecting) {
                const card = e.target;
                const v = card.querySelector('video[data-src]');
                const img = card.querySelector('img[data-src]');
                if(v && v.dataset.src) { v.src = v.dataset.src; v.removeAttribute('data-src'); }
                if(img && img.dataset.src) { img.src = img.dataset.src; img.removeAttribute('data-src'); }
                obs.unobserve(card);
            }
        });
    }, { rootMargin: '400px' });
}

/* ================= 智能扫描 (递归 + 错误计数) ================= */
async function smartScan(category, index=1, errors=0) {
    if (index > MAX_SEARCH || errors > MAX_ERRORS) return;

    const checks = EXTENSIONS.map(ext => new Promise(resolve => {
        const url = `images/${encodeURIComponent(category.id)}/${index}${ext}`;
        const isVideo = ext === '.mp4' || ext === '.mov';
        if (isVideo) {
            // 仅加载 metadata（若被 CORS 阻塞也会触发 error）
            const v = document.createElement('video');
            v.preload = 'metadata';
            v.src = url;
            v.onloadedmetadata = () => { resolve({ ok: true, src: url, isVideo: true, w: v.videoWidth || 1600, h: v.videoHeight || 900 }); v.src = ''; };
            v.onerror = () => resolve({ ok: false });
        } else {
            const img = new Image();
            img.src = url;
            img.onload = () => resolve({ ok: true, src: url, isVideo: false, w: img.width, h: img.height });
            img.onerror = () => resolve({ ok: false });
        }
    }));

    const results = await Promise.all(checks);
    const found = results.find(r => r.ok);

    if (found) {
        addItem(found.src, category.id, found.w, found.h, found.isVideo);
        // 继续查找下一张，重置错误计数
        smartScan(category, index + 1, 0);
    } else {
        // 本序号所有后缀都不存在，计一次错误，继续
        smartScan(category, index + 1, errors + 1);
    }
}

/* ================= 添加项到池并触发布局 ================= */
function addItem(src, catId, w, h, isVideo=false) {
    const item = {
        src, catId, catName: catId, w, h, ratio: (w && h) ? (w / h) : 1.6, isVideo
    };
    loadedItems.push(item);
    // 防抖小延迟合并重绘
    requestLayout();
}
let layoutTimer = null;
function requestLayout() {
    if (layoutTimer) clearTimeout(layoutTimer);
    layoutTimer = setTimeout(layout, 60);
}

/* ================= 建立列（响应式） ================= */
function buildColumns() {
    galleriesRoot.innerHTML = '';
    columnsDOM = [];
    let colCount = 4;
    if (window.innerWidth <= 600) colCount = 1;
    else if (window.innerWidth <= 1000) colCount = 2;

    for (let i = 0; i < colCount; i++) {
        const col = document.createElement('div');
        col.className = 'masonry-column';
        galleriesRoot.appendChild(col);
        columnsDOM.push(col);
    }
}

/* 保持 resize 事件不被覆盖 */
window.addEventListener('resize', () => {
    buildColumns();
    layout();
    resizeCanvas();
});

/* ================= 布局核心（无闪烁：只移动必要 DOM） ================= */
function layout() {
    if (columnsDOM.length === 0) buildColumns();

    const items = (currentFilter === 'all') ? loadedItems : loadedItems.filter(it => it.catId === currentFilter);

    // 排序：按添加顺序（已是自然顺序），如需更复杂可改
    // items.sort((a,b)=> a.index - b.index);

    // 计算列高度估算
    const colHeights = new Array(columnsDOM.length).fill(0);

    // 简单清理：只移除那些不再应显示的 DOM（这里选择重建列以保持简洁）
    columnsDOM.forEach(c => c.innerHTML = '');

    items.forEach(item => {
        // 选择最短列
        let minIdx = 0;
        for (let i = 1; i < colHeights.length; i++) if (colHeights[i] < colHeights[minIdx]) minIdx = i;
        const targetCol = columnsDOM[minIdx];

        // 创建卡片 DOM
        const card = document.createElement('div');
        card.className = 'photo-card';
        card.setAttribute('role','button');
        card.tabIndex = 0;

        const mediaWrap = document.createElement('div');
        mediaWrap.className = 'media-wrapper';

        if (item.isVideo || /\.(mp4|mov)$/i.test(item.src)) {
            const v = document.createElement('video');
            v.setAttribute('playsinline','');
            v.muted = true;
            v.loop = true;
            // 使用 data-src 延迟加载
            v.setAttribute('data-src', item.src);
            v.preload = 'metadata';
            mediaWrap.appendChild(v);
        } else {
            const img = document.createElement('img');
            img.setAttribute('data-src', item.src);
            img.alt = item.src.split('/').pop() || 'image';
            mediaWrap.appendChild(img);
        }

        const info = document.createElement('div');
        info.className = 'card-info';
        info.innerHTML = `<span class="card-tag">${item.catName}</span><div class="card-title">${item.src.split('/').pop()}</div>`;

        card.appendChild(mediaWrap);
        card.appendChild(info);

        // 点击打开灯箱（支持键盘回车）
        card.onclick = () => openLightbox(item.src, item.isVideo);
        card.onkeydown = (e) => { if (e.key === 'Enter') openLightbox(item.src, item.isVideo); };

        targetCol.appendChild(card);

        // 观察 lazy load 与 reveal
        lazyMediaObserver.observe(card);
        revealObserver.observe(card);

        // 增加估算高度（用于后续列选择）
        // 使用 ratio 估算：假设目标显示宽度为 columnWidth（近似）
        const colWidth = targetCol.getBoundingClientRect().width || (document.documentElement.clientWidth / columnsDOM.length);
        const estHeight = colWidth / (item.ratio || 1.6) + 96; // 图片高度 + info 区估算
        colHeights[minIdx] += estHeight;
    });
}

/* ================= 灯箱 ================= */
function openLightbox(src, isVideo=false){
    lightbox.classList.add('active');
    lightbox.setAttribute('aria-hidden', 'false');
    lightboxContent.innerHTML = '';
    if (isVideo || /\.(mp4|mov)$/i.test(src)) {
        const v = document.createElement('video');
        v.src = src;
        v.controls = true;
        v.autoplay = true;
        v.playsInline = true;
        lightboxContent.appendChild(v);
    } else {
        const img = document.createElement('img');
        img.src = src;
        img.alt = '';
        lightboxContent.appendChild(img);
    }
}
// 关闭（点灯箱背景或 Esc）
lightbox.onclick = closeLightbox;
function closeLightbox(){
    lightbox.classList.remove('active');
    lightbox.setAttribute('aria-hidden', 'true');
    lightboxContent.innerHTML = '';
}
window.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeLightbox(); });

/* ================= 画布粒子（较轻量） ================= */
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let DPR = Math.max(1, window.devicePixelRatio || 1);
let canvasW = 0, canvasH = 0;
let particles = [];
let rafId = null;
let canvasRunning = true;

function resizeCanvas(){
    DPR = Math.max(1, window.devicePixelRatio || 1);
    canvasW = window.innerWidth;
    canvasH = window.innerHeight;
    canvas.width = canvasW * DPR;
    canvas.height = canvasH * DPR;
    canvas.style.width = canvasW + 'px';
    canvas.style.height = canvasH + 'px';
    ctx.setTransform(DPR,0,0,DPR,0,0);
    // 重建粒子适配尺寸（保持数量固定）
    initParticles();
}
function initCanvas(){
    resizeCanvas();
    // 当页面不可见时暂停动画
    document.addEventListener('visibilitychange', ()=>{
        if (document.hidden) stopCanvas(); else startCanvas();
    });
    startCanvas();
}
function initParticles(){
    const count = Math.max(80, Math.floor(120 / (DPR || 1)));
    particles = [];
    for (let i=0;i<count;i++){
        particles.push({
            x: Math.random()*canvasW,
            y: Math.random()*canvasH,
            vx: (Math.random()-0.5)*0.6,
            vy: (Math.random()-0.5)*0.6,
            r: Math.random()*2+0.6
        });
    }
}
function drawCanvas(){
    ctx.clearRect(0,0,canvasW,canvasH);
    particles.forEach(p=>{
        p.x += p.vx; p.y += p.vy;
        if (p.x < -10) p.x = canvasW + 10;
        if (p.x > canvasW + 10) p.x = -10;
        if (p.y < -10) p.y = canvasH + 10;
        if (p.y > canvasH + 10) p.y = -10;
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
        ctx.fillStyle = "rgba(120,160,255,0.32)";
        ctx.fill();
    });
}
function loopCanvas(){
    if (!canvasRunning) return;
    drawCanvas();
    rafId = requestAnimationFrame(loopCanvas);
}
function startCanvas(){
    if (canvasRunning) return;
    canvasRunning = true;
    loopCanvas();
}
function stopCanvas(){
    canvasRunning = false;
    if (rafId) cancelAnimationFrame(rafId);
    rafId = null;
}
window.addEventListener('resize', resizeCanvas);

/* 首次初始化粒子 */
initParticles();

/* ================= 防抖 / 小工具 (already used) ================= */
/* requestLayout 已实现 */

/* ================= 额外友好：避免自动播放大量视频（浏览器限制） ================= */
/* Autoplay 在多数浏览器要求 muted 才能自动播放，卡片内的视频使用 muted，灯箱播放时显示 controls。 */

/* ================= 小结日志（可注释） ================= */
console.log('Portfolio script loaded. Items will appear as images/videos are found in images/<category>/<n>.<ext>');
</script>
</body>
</html>
